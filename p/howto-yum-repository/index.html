<!doctype html>
<html><head>
<meta charset="UTF-8">
<title>World of Hal Canary</title>
<link rel="stylesheet" type="text/css" href="/styles/scrapple-from-the-apple.css">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<meta name="viewport" content="width=532">
<script>
function search_hco() {
  document.getElementById("search-link-halcanary-org").style.display = "none";
  document.getElementById("search-halcanary-org").style.display = "block";
  return false;
}
</script>
</head>
<body><div class="column" style="width:512px;">
<h1><a href="/" class="hiddenlink"><img src="/images/Hal_W_Canary_3_hand.jpg" alt="Hal W Canary, III" width="400" height="91" style="border:0px"></a></h1>
<div class="section">
<nav><p><a href="/">Home</a></p></nav>
</div>

<!-- p/howto-yum-repository -->

<div class="section">

<h2>How to make a local yum repository mirror.</h2>

<p>By Hal Canary &lt;hal at ups dot physics dot wisc dot edu&gt;</p>

<h3>Intro</h3>

<p>
Last week a friend of mine with a slow dial-up internet connection
asked how he could download all of the newest updates for his FC1
system and take them home on a CD.  I showed him how.
</p>

<p>
A small cluster of a router, one server and two workstations all have
FC1 installed.  Why not save upstream bandwidth by locally mirroring
all updates?  That's just what I did.
</p>

<p>
Let's get started.  What you'll need: a server with httpd and plenty
of extra hard-drive space (At least 5 GB).  To retrieve the packages
you'll need the rsync client.  To automate the process you'll need the
cron d&aelig;mon.  And of course, you'll need to have yum on your clients.
</p>

<h3>Step one.  Use rsync to mirror a repository.</h3>

<p>
I happen to have a directory on my server called /space.  It's a
user-writable location that doesn't get included in my weekly backups
like /home does.  I'll create a directory /space/mirror for all of my
mirrors.  Then I softlink the directory so that it shows up on my
webserver.
</p>

<pre style="margin-left: 3em;">
$ mkdir -p /space/mirror
# ln -s /space/mirror /var/www/html/
$ ls -l /var/www/html/mirror
lrwxrwxrwx 1 root  root   18 Jan 25 03:04 /var/www/html/mirror -> \
/space/mirror
</pre>

<p>
(I'm doing all of the following steps as a non-root user.  Safer that
way.)
</p>

<p>
Now I'll write a script that does the syncing.  The script doesn't do
much but call into rsync to do all of the heavy lifting.  I wrote
mirrors.kernel.org here, but you will want to find a closer mirror.
</p>

<pre style="margin-left: 3em;">
#!/bin/sh
# mirror-script.sh
# hal canary
DATE=`/bin/date +%Y-%m-%d`
OUTDIR='/tmp'
MIRROR=/space/mirror
[ -d $OUTDIR ] || mkdir -p $OUTDIR
OUTFILE=$OUTDIR/mirror-output-$DATE.txt

/bin/nice /usr/bin/rsync --verbose --progress \
   --stats --archive --partial \
   --exclude development/ \
   --exclude test/ \
   --exclude 1/SRPMS/ \
   --exclude 1/i386/iso/yarrow-SRPMS-disc1.iso \
   --exclude 1/i386/iso/yarrow-SRPMS-disc2.iso \
   --exclude 1/i386/iso/yarrow-SRPMS-disc3.iso \
   --exclude 1/i386/debug/ \
   --exclude updates/testing/ \
   --exclude updates/1/SRPMS \
   --exclude updates/1/i386/SRPMS/ \
   --exclude updates/1/i386/debug/ \
   mirrors.kernel.org::fedora/core/ $MIRROR/fedora/core/ \
   &gt;&gt; $OUTFILE
</pre>

<p>
You'll notice that most of the arguments are exclude statements.  I
don't need to sync any of the source rpms, so I'll leave those out.
</p>

<p>
Now make that file executable and execute it.
</p>

<pre style="margin-left: 3em;">
$ chmod +x mirror-script.sh
$ ./mirror-script.sh
</pre>

<p>
It will take some time to download all of those files.  Come back in
an hour or two. you can use 'tail -f mirror-output-&lt;date&gt;.txt' to
watch the progress.
</p>

<p>
Once you're done, try browsing to http://[YOUR_SERVER_NAME]/mirror to
check that it works.  (Assuming your http d&aelig;mon is up and running.)
</p>

<h3>Step Two:  Automating the mirror</h3>

<p>
I made a file called $HOME/.crontab that contains the line:
</p>

<pre style="margin-left: 3em;">
15 1 * * * /space/mirror/mirror-script.sh
</pre>

<p>
You can edit this file all you want.  This will run the script at
1:15am every day.  Then I ran the crontab program to make this a cron
job:
</p>

<pre style="margin-left: 3em;">
$ crontab ~/.crontab
</pre>

<p>
'crontab -l' tells you what jobs the cron d&aelig;mon will do for a
particular user.
</p>

<pre style="margin-left: 3em;">
$ crontab -l
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (/home/hal/.crontab installed on Sun Jan 25 15:24:10 2004)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 ...
15 1 * * * /space/mirror/mirror-script.sh
</pre>


<h3>Step Three:  Making a CD copy of updates. (optional)</h3>

<p>
This should burn all contents of the update directory onto a
CD, assuming cdrecord is setup (look at /etc/cdrecord.conf).
</p>

<pre style="margin-left: 3em;">
$ mkisofs -r -J \
  -V &quot;Fedora Updates as of `/bin/date +%Y-%m-%d`&quot; \
  /space/mirror/fedora/core/updates/1/i386/ \
  | cdrecord -v -
</pre>

<p>
That should be it.
</p>

<h3>Step four:  Setting up repositories.</h3>

<p>
Now, (as root) edit your /etc/yum.conf file on each machine you want
to look at the mirror
</p>

<pre style="margin-left: 3em;">
[base]
name=Fedora Core $releasever - $basearch - Base
baseurl=http://[YOUR_SERVER_NAME]/mirror/fedora/core/1/i386/os/
gpgcheck=1
 
[updates-released]
name=Fedora Core $releasever - $basearch - Released Updates
baseurl=http://[YOUR_SERVER_NAME]/mirror/fedora/core/updates/1/i386/
gpgcheck=1
</pre>

<p>
Then do an update just to check it out:
</p>

<pre style="margin-left: 3em;">
# yum update
</pre>

<p style="text-align:right;">
(c) 2004 Hal Canary.  <br />
Verbatim copying of this article is permitted
in any medium, provided this notice is preserved.</p>

</div>

<div class="section">
<h2>Responses</h2>

<h3>yum-arch?</h3>

<pre style="margin-left: 3em;">
From: &quot;Robert P. J. Day&quot; &lt;------@----------.---&gt;
Date: Tue, 10 Feb 2004 09:14:30 -0500 (GMT-05:00)
To: &quot;Hal Canary&quot; &lt;---@---.-------.----.---&gt;
Subject: fedoranews: setting up a local yum repository

if you're explaining how to set up a local yum repository, don't you
somewhere have to run &quot;yum-arch&quot; to create the proper structure?  or
am i misunderstanding the purpose of that article?  thanks.

rday
</pre>

<p>
If you get the headers/ directory with rsync, then yum-arch is
redundant.
</p>

<h3>using an update cd</h3>

<pre style="margin-left: 3em;">
From: Curtis Rempel &lt;------@-----.---&gt;
Date: Fri, 20 Feb 2004 09:36:48 -0700
To: &quot;Hal Canary&quot; &lt;---@---.-------.----.---&gt;
Subject: re: How to make a local yum repository mirror

Hi,

I enjoyed your article on FedoraNEWS.ORG and got everything going - I
basically had the right idea but your article solidified things for
me.  Thanks!

One question - now that I've got all the updates on CD, I'm having
some trouble applying them to a machine w/o network access.  I've
mounted the CD and can see all the updates and I modified the
/etc/sysconfig/rhn/sources on that machine to point to /mnt/cdrom for
updates-released (i.e. the line is: yum updates-released /mnt/cdrom),
however, when I click on the update icon, it complains it cannot
access the updates: &quot;The applet has been unable to access the
following information sources in its last attempts: updates-released @
/mnt/cdrom&quot;

What little detail am I missing here?

Thanks!

Curtis
</pre>

<p>
I've heard that yum has problems with using local files.  Try starting
httpd and linking to those files from /var/www:
</p>

<pre style="margin-left: 3em;">
sudo /sbin/service httpd start
sudo ln -s /mnt/cdrom /var/www/update</pre>

<p>
Then point yum at the http://localhost/update url.
</p>

<p style="text-align:right;">
(c) 2004 Hal Canary.  <br />Verbatim copying of this article is
permitted in any medium, provided this notice is preserved. <br />
Responses are the property of the responders.</p>


</div>

<div class="section"><p class="rightside">file modification time: 2004-02-20 18:30:44</p></div>

<div class="section">
<p class="centered">Copyright 1997-2013 by Hal Canary.<br>
<i>mailto: halcanary at gmail dot com</i><br>
<a href="https://halcanary.org"><i>http://halcanary.org</i></a></p>
</div>
</div>
</body>
</html>
