#! /usr/bin/env python3
# coding=utf-8

import os
import sys
import html

import wohc

def get_files(directory):
    for subdir, _, filenames in os.walk(directory):
        for filename in filenames:
            yield os.path.join(subdir, filename)

def main():
    TEMPLATE = '''<!doctype html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{url1}</title>
<script>window.location.replace("{url2}");</script>
<link rel="icon" href="data:image/png;base64,{icon}">
<body><a style="overflow-wrap:break-word" href="{url1}">{url1}</a></body>
</html>
'''
    ROOT = 'https://halcanary.org/'
    BASE_DIR = os.path.dirname(__file__) + '/../'
    REDIRECTS_DIR = BASE_DIR + 'src/redirects'
    for redirects_file in get_files(REDIRECTS_DIR):
        key = os.path.relpath(redirects_file, REDIRECTS_DIR)
        with open(redirects_file) as f:
            value = f.read().strip()
        path = os.path.normpath(BASE_DIR + key)
        if not os.path.exists(path):
            os.makedirs(path)
        escaped_value = html.escape(value)
        short = escaped_value.replace(ROOT, '/', 1) if escaped_value.startswith(ROOT) else escaped_value
        with open(path + '/index.html', 'w') as o:
            o.write(TEMPLATE.format(url1=short, url2=value, icon=wohc.ICON))
        sys.stdout.write(key + '\n')

if __name__ == '__main__':
    main()
